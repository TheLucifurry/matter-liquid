/*! For license information please see matter-liquid.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("matter-js")):"function"==typeof define&&define.amd?define(["matter-js"],e):"object"==typeof exports?exports.MatterLiquid=e(require("matter-js")):t.MatterLiquid=e(t.Matter)}(self,(function(t){return function(){"use strict";var e={771:function(t,e,s){s.r(e);var i=JSON.parse('{"u2":"matter-liquid","i8":"0.0.1"}'),r=s(538),n=s.n(r);function o(t){return Math.hypot(t[0],t[1])}function a(t){const e=Math.hypot(t[0],t[1]);return 0!==e?[t[0]/e,t[1]/e]:[0,0]}function c(t,e){return[t[0]*e,t[1]*e]}function l(t,e){return[t[0]/e,t[1]/e]}function u(t,e){return[e[0]-t[0],e[1]-t[1]]}function h(t,e,s,i,r,n){return t>s&&t<r&&e>i&&e<n}function d(t,e,s){const i=s-e;return e+((t-e)%i+i)%i}function f(t,e,s){return Math.min(Math.max(t,e),s)}function p(t,e){const[s,i,r,n]=e;return[t.min.x-n,t.min.y-s,t.max.x+i,t.max.y+r]}function m(t){return"number"==typeof t?[t,t,t,t]:[t[0],t[1],t[2]||t[0],t[3]||t[1]]}function g(t,e){let s=-1;const{length:i}=t;for(;++s<i;)e(t[s],s)}function v(t,e,s,i){g(s,((t,s)=>{null===t||e&&!h(t[0],t[1],...e)||i(t,s)}))}function y(t,e,s){g(e,(e=>s(t[e],e)))}function x(t,e){return t.spatialHash.getAroundCellsItems(e[0],e[1],t.particles)}function P(t,e,s){!function(t,e,s){g(e,(e=>s(t[e],e)))}(t.particles,x(t,e),s)}function S(t,e){for(const[s,i]of Object.entries(t))e(s,i)}function b(t,e){return u([t[0],t[1]],[e[0],e[1]])}function C(t,e){t[0]+=e[0],t[1]+=e[1]}function M(t,e,s){t[2]+=e*s[0],t[3]+=e*s[1]}function R(t,e){t[0]+=e*t[2],t[1]+=e*t[3]}function w(t,e,s){const i=.2*t.radius,r=.3*t.radius;let n=0,u=0;const h=x(t,e),d=[];for(let s=0;s<h.length;s++){const i=t.particles[h[s]],r=b(e,i),a=o(l(r,t.radius));if(a<1){const t=1-a;n+=t**2,u+=t**3,d.push([t,r,i])}}const f=.3*(n-i),p=r*u,m=[0,0];for(let t=0;t<d.length;t++){const[e,i,r]=d[t],n=l(c(a(i),s**2*(f*e+p*e**2)),2);m[0]-=n[0],m[1]-=n[1],C(r,n)}C(e,m)}function I(t,e,s,i){y(t.particles,e,((e,r)=>{!function(t,e,s){t[2]=(t[0]-s[0])/e,t[3]=(t[1]-s[1])/e}(e,s,i[r]);const n=t.world.bounds;if(t.isWrappedX)e[0]=d(e[0],n.min.x,n.max.x);else{const t=e[0];e[0]=f(t,n.min.x,n.max.x),t!==e[0]&&(e[2]*=-1)}if(t.isWrappedY)e[1]=d(e[1],n.min.y,n.max.y);else{const t=e[1];e[1]=f(t,n.min.y,n.max.y),t!==e[1]&&(e[3]*=-1)}t.spatialHash.update(r,e[0],e[1])}))}function O(t,e){const s=t.store,i=[],r=t.getGravity(),n={};v(0,s.isRegionalComputing?p(s.render.bounds,s.activeBoundsPadding):null,s.particles,((t,o)=>{i.push(o),M(t,e,r),n[o]=[t[0],t[1]],function(t,e){const[s,i]=function(t,e){const s=Math.hypot(t[0],t[1]);return c(l(t,s||1),Math.max(0,Math.min(e,s)))}([t[2],t[3]],e);t[2]=s,t[3]=i}(t,.6*s.radius),R(t,e)})),y(s.particles,i,(t=>{w(s,t,e)})),I(s,i,e,n)}function q(t,e){const s=t.store,i=p(s.render.bounds,s.activeBoundsPadding),r=[],n=t.getGravity(),h={};v(0,i,s.particles,((t,s)=>{r.push(s),M(t,e,n)})),y(s.particles,r,(t=>{!function(t,e,s){P(t,e,(i=>{const r=b(e,i),n=a(r),h=o(l(r,t.radius));if(h<1){const t=o((g=e,m=u([(v=i)[2],v[3]],[g[2],g[3]]),[(p=n)[0]*m[0],p[1]*m[1]]));if(t>0){const r=l(c(n,s*(1-h)*(.01*t+.01*t**2)),2);f=r,(d=e)[2]-=f[0],d[3]-=f[1],function(t,e){t[2]+=e[0],t[3]+=e[1]}(i,r)}}var d,f,p,m,g,v}))}(s,t,e)})),y(s.particles,r,((t,s)=>{h[s]=[t[0],t[1]],R(t,e)})),function(t,e,s){y(t.particles,e,((e,i)=>{P(t,e,((r,n)=>{if(o(l(b(e,r),t.radius))<1){const a=o(b(e,r));let c=10-a;const l=function(t,e){return`${t}.${e}`}(i,n),u=.1*c;a>10+u?c+=.03*s*(a-10-u):a<10-u&&(c-=.03*s*(10-u-a)),void 0===t.springs[l]&&(t.springs[l]=c)}}))})),S(t.springs,((e,s)=>{Math.abs(s)>t.radius&&(t.springs[e]=void 0)})),S(t.springs,((e,i)=>{const[r,n]=function(t){const[e,s]=t.split(".");return[+e,+s]}(e),u=t.particles[r],h=t.particles[n],d=b(u,h),f=a(d),p=o(d),m=i,g=l(c(f,s**2*.001*(1-m/t.radius)*(m-p)),2);var v,y;y=g,(v=u)[0]-=y[0],v[1]-=y[1],C(h,g)}))}(s,r,e),y(s.particles,r,(t=>{w(s,t,e)})),I(s,r,e,h)}function B(t,e){const s=t.split(".");return[s[0]*e,s[1]*e]}function j(t){const{particles:e,liquidOfParticleId:s}=t,i=t.render.context,r=p(t.render.bounds,t.renderBoundsPadding);g(e,((t,e)=>{if(null===t||!h(t[0],t[1],...r))return;const n=Math.floor(t[0]),o=Math.floor(t[1]),a=s[e].texture,c=a.height/2;i.drawImage(a,n-c,o-c)}))}function k(t){Matter.Render.startViewTransform(t.store.render),j(t.store)}function z(t){const{store:e}=t,s=e.render.context;Matter.Render.startViewTransform(e.render);const i=p(e.render.bounds,e.renderBoundsPadding),r=p(e.world.bounds,[0,0,0,0]),n=p(e.render.bounds,e.activeBoundsPadding);!function(t){const e=t.render.context,{cellSize:s}=t.spatialHash,i=s/2,r=Object.entries(t.spatialHash.hash);e.textAlign="center",e.lineWidth=1,e.fillStyle="white",e.strokeStyle="green";for(const[t,n]of r){const[r,o]=B(t,s);e.fillText(`${n.length}`,r+i,o+i),e.strokeRect(r,o,s,s)}}(e),j(e),s.strokeStyle="violet",s.strokeRect(r[0],r[1],r[2]-r[0],r[3]-r[1]),s.strokeStyle="orange",s.strokeRect(n[0],n[1],n[2]-n[0],n[3]-n[1]),s.strokeStyle="cyan",s.strokeRect(i[0],i[1],i[2]-i[0],i[3]-i[1]);s.lineWidth=1,s.strokeStyle="yellow",s.beginPath(),s.moveTo(-1e3,0),s.lineTo(1e3,0),s.moveTo(0,-1e3),s.lineTo(0,1e3),s.stroke()}function T(t,e){return Math.round(t/e)}function U(t,e){return`${t}.${e}`}function E(t=[],e){const s=t.indexOf(e);return-1!==s&&t.splice(s,1),t}const F=[-1,-1,0,-1,1,-1,-1,0,1,0,-1,1,0,1,1,1];class H{constructor(){this.hash={},this.prevItemCell={}}init(t){this.cellSize=t}find(t,e){return(this.hash[t]||[]).indexOf(e)}save(t,e){const s=this.hash[e];void 0===s?(this.hash[e]=[t],this.prevItemCell[t]=e):-1===this.find(e,t)&&(s.push(t),this.prevItemCell[t]=e)}_delete(t,e){const s=this.find(e,t);this.hash[e].splice(s,1),delete this.prevItemCell[t],0===this.hash[e].length&&delete this.hash[e]}update(t,e,s){const i=T(e,this.cellSize),r=T(s,this.cellSize),n=this.prevItemCell[t],o=U(i,r);n!==o&&(void 0!==n&&this._delete(t,n),this.save(t,o))}clear(){this.hash={},this.prevItemCell={}}insert(t,e,s){const i=U(T(e,this.cellSize),T(s,this.cellSize));this.save(t,i)}remove(t){const e=this.prevItemCell[t];this._delete(t,e)}getAroundCellsItems(t,e,s){const i=T(t,this.cellSize),r=T(e,this.cellSize),n=U(i,r),o=[...E(this.hash[n],n)];for(let t=0;t<F.length;t+=2){const e=i+F[t],s=r+F[t+1];o.push(...this.hash[U(e,s)]||[])}return o}fill(t){t.forEach(((t,e)=>{const s=t[0],i=t[1];this.insert(e,s,i)}))}getItemsOfCellsInBounds(t){const e=T(t.min.x,this.cellSize),s=T(t.min.y,this.cellSize),i=T(t.max.x,this.cellSize),r=T(t.max.y,this.cellSize),n=[];for(let t=s;t<=r;t++)for(let s=e;s<=i;s++){const e=U(s,t);n.push(...this.hash[e]||[])}return n}}const A=["pauseChange","particleRemove"];class W extends class{constructor(t){this.events=function(){const t={};return A.forEach((e=>t[e]=()=>0)),t}();const e=t.radius||32,s=e*(t.particleTextureScale||.3);let i=[!1,!1];const r=t.worldWrapping;null!=r&&(i="boolean"==typeof r?[r,r]:r),this.store={radius:e,isWrappedX:i[0],isWrappedY:i[1],engine:t.engine,render:t.render,world:t.engine.world,isRegionalComputing:t.isRegionalComputing||!1,liquids:t.liquids.map((t=>function(t,e){const s={color:"#fff",plasticity:.3,texture:null,...t};return s.texture=t.texture||function(t,e){const s=new OffscreenCanvas(4*e,4*e),i=s.getContext("2d");return i.shadowColor=t,i.shadowBlur=e,i.beginPath(),i.fillStyle=t,i.arc(2*e,2*e,e,0,2*Math.PI),i.fill(),s}(s.color,e),s}(t,s))),isPaused:!1,gravityRatio:.2,spatialHash:new H,renderBoundsPadding:[0,0,0,0],activeBoundsPadding:[0,0,0,0],particles:[],springs:{},freeParticleIds:[],liquidOfParticleId:{},tick:0,everyFrame:2,timeScale:1}}setPause(t=!0){this.store.isPaused=t,this.events.pauseChange(t)}setRenderBoundsPadding(t){this.store.renderBoundsPadding=m(t)}setActiveBoundsPadding(t){this.store.activeBoundsPadding=m(t)}setGravityRatio(t=this.store.gravityRatio){this.store.gravityRatio=t}setUpdateEveryFrame(t=this.store.everyFrame){this.store.everyFrame=t}setTimeScale(t=this.store.timeScale){this.store.timeScale=t}getGravity(){return[this.store.world.gravity.x*this.store.gravityRatio,this.store.world.gravity.y*this.store.gravityRatio]}getParticlesCount(){return this.store.particles.length-this.store.freeParticleIds.length}}{constructor(t){super(t),this.setGravityRatio(t.gravityRatio),this.store.spatialHash.init(this.store.radius),this.setUpdateEveryFrame(t.updateEveryFrame),this.setTimeScale(t.timeScale),this.setUpdaters(t),n().Events.on(t.render,"afterRender",this.updateRender.bind(this))}setUpdaters(t){this.renderUpdater=t.isDebug?z:k,this.computeUpdater=t.isAdvancedAlgorithm?q:O,this.updateCompute=this.updateCompute.bind(this),this.setPause(!!t.isPaused)}updateCompute(){this.store.tick++%this.store.everyFrame==0&&this.computeUpdater(this,this.store.engine.timing.timeScale*this.store.timeScale)}updateRender(){this.renderUpdater(this)}setPause(t=!0){t?n().Events.off(this.store.engine,"afterUpdate",this.updateCompute):n().Events.on(this.store.engine,"afterUpdate",this.updateCompute),super.setPause(t)}spawnParticle(t,e,s){const i=0===this.store.freeParticleIds.length?this.store.particles.length:this.store.freeParticleIds.pop(),r=new Float32Array(4);r[0]=e,r[1]=s,r[2]=0,r[3]=0,this.store.liquidOfParticleId[i]=this.store.liquids[t],this.store.particles[i]=r,this.store.spatialHash.insert(i,e,s)}removeParticle(t){const e=this.store.particles[t];this.store.particles[t]=null,this.store.spatialHash.remove(t),this.events.particleRemove(e,t,this.store.liquidOfParticleId[t]),this.store.freeParticleIds.push(t)}fillZoneByLiquid(t,e,s,i,r,n=this.store.radius){const o=n/2,a=Math.max(1,Math.trunc(s/n)),c=Math.max(1,Math.trunc(i/n));for(let s=0;s<a;s++)for(let i=0;i<c;i++){const l=t+o+s*n,u=e+o+i*n;this.spawnParticle(r,l,u),s!==a-1&&i!==c-1&&this.spawnParticle(r,l+o,u+o)}}clearZoneByLiquid(t,e,s,i,r){this.store.particles.forEach(((r,n)=>{null!==r&&h(r[0],r[1],t,e,t+s,e+i)&&this.removeParticle(n)}))}checkRectContainsParticle(t,e){return h(e[0],e[1],...t)}}const _={name:i.u2,version:i.i8,for:"matter-js@0.16.1",install(t){t.Liquid={create:t=>new W(t)}}};Matter.Plugin.register(_)},538:function(e){e.exports=t}},s={};function i(t){if(s[t])return s[t].exports;var r=s[t]={exports:{}};return e[t](r,r.exports,i),r.exports}return i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,{a:e}),e},i.d=function(t,e){for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(771)}()}));